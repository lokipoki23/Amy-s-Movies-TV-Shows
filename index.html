<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMDb Search & List Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      margin-top: 40px;
    }

    #search-container {
      position: relative;
      max-width: 400px;
      margin-bottom: 20px;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    #autocomplete {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      border: 1px solid #ccc;
      border-top: none;
      background: white;
      z-index: 1000;
      border-radius: 0 0 4px 4px;
      max-height: 300px;
      overflow-y: auto;
    }

    .autocomplete-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }

    .autocomplete-item img {
      width: 50px;
      height: 75px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .movie-info {
      display: flex;
      flex-direction: column;
    }

    .movie-title {
      font-weight: bold;
    }

    .movie-year {
      font-size: 0.9em;
      color: #666;
    }

    .autocomplete-item:hover {
      background-color: #f0f0f0;
    }

    /* Details container */
    #details-container {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
      margin-top: 10px;
      max-width: 800px;
      background: #f9f9f9;
      display: none;
      overflow: hidden;
    }

    /* Crossfade backdrops */
    .backdrop-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 180px;
      overflow: hidden;
      border-radius: 10px 10px 0 0;
    }

    .backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 20%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0) 70%);
      -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 20%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0) 70%);
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    .backdrop.visible {
      opacity: 1;
    }

    .details-top-row {
      position: relative;
      z-index: 1;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .details-poster-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 45px;
      width: 140px;
    }

    #details-container img {
      width: 140px;
      height: auto;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .action-buttons button {
      width: 100%;
      padding: 4px 0;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: black;
      font-weight: 600;
      text-align: center;
      transition: background-color 0.2s ease;
    }

    .add-btn {
      background-color: #90ee90;
    }

    .add-btn:hover {
      background-color: #76c776;
    }

    .delete-btn {
      background-color: #f08080;
      color: black;
      font-weight: 600;
      border: none;
      padding: 4px 0;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s ease;
    }

    .delete-btn:hover {
      background-color: #d75c5c;
    }

    .view-btn {
      background-color: #add8e6;
    }

    .view-btn:hover {
      background-color: #87b7d9;
    }

    .details-text-header {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      flex: 1;
      padding-top: 100px;
    }

    .details-text-header h3 {
      margin: 0 0 6px 0;
    }

    .details-overview {
      font-size: 14px;
      line-height: 1.6;
      color: #555;
    }

    #movie-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .movie {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.2s;
    }

    .movie img {
      width: 120px;
      height: auto;
      border-radius: 6px;
    }

    .movie span {
      margin-top: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  
  <h2>Search TMDb</h2>
  <div id="search-container">
    <select id="search-type">
      <option value="movie">Movie</option>
      <option value="tv">TV Show</option>
    </select>
    <input type="text" id="search" placeholder="Start typing a title..." autocomplete="off" />
    <div id="autocomplete"></div>
  </div>
  
  <div id="details-container"></div>

  <h2 id="list-heading">My Movie List</h2>
  <div id="movie-list">Loading...</div>

  <script>
    const apiKey = 'c8c477754ad23697ae0ac2371caf01ea';
    const accessToken = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJjOGM0Nzc3NTRhZDIzNjk3YWUwYWMyMzcxY2FmMDFlYSIsIm5iZiI6MTc1NDIxMjc3OS4xMTc1NTMsImp0aSI6IjY4OGYyOGFmZTVhZTcyNTlmYzc4MzBjYiIsInN1YiI6IjY2ODNmZGUzN2E5ZmIxNGI4Y2ZiMWE2MyIsInNjb3BlcyI6WyJhcGlfcmVhZCIsImFwaV93cml0ZSJdLCJ2ZXJzaW9uIjoyfQ.CxUPjBuSJpg-hAeHt0dB2Y9Li2LR8jJ3W3bNjPYDJuE';

    const listIds = {
      movie: '8547360',
      tv: '8547361'
    };

    const posterBaseUrl = 'https://image.tmdb.org/t/p/w185';

    const searchInput = document.getElementById('search');
    const searchType = document.getElementById('search-type');
    const autocompleteBox = document.getElementById('autocomplete');
    const detailsContainer = document.getElementById('details-container');
    const listContainer = document.getElementById('movie-list');
    const listHeading = document.getElementById('list-heading');

    let currentListIds = new Set();
    let backdropInterval;

    async function addItemToList(itemId, itemType) {
      try {
        const listId = listIds[itemType];
        const url = `https://api.themoviedb.org/4/list/${listId}/items`;
        const body = JSON.stringify({
          items: [{
            media_type: itemType,
            media_id: itemId
          }]
        });

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: body
        });

        const data = await res.json();

        if (data.success) {
          alert('Item added successfully!');
          detailsContainer.style.display = 'none';
          loadList();
        } else {
          alert('Failed to add item: ' + data.status_message);
        }
      } catch (error) {
        console.error('Add API call error:', error);
      }
    }

    async function deleteItemFromList(itemId, itemType) {
      try {
        const listId = listIds[itemType];
        const url = `https://api.themoviedb.org/4/list/${listId}/items`;
        const body = JSON.stringify({
          items: [{
            media_type: itemType,
            media_id: itemId
          }]
        });

        const res = await fetch(url, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: body
        });

        const data = await res.json();

        if (data.success) {
          alert('Item deleted successfully!');
          detailsContainer.style.display = 'none';
          loadList();
        } else {
          alert('Failed to delete item: ' + data.status_message);
        }
      } catch (error) {
        console.error('Delete API call error:', error);
      }
    }

    async function displayDetails(item, type) {
      detailsContainer.style.display = 'flex';
      detailsContainer.innerHTML = '';
      autocompleteBox.innerHTML = '';
      searchInput.value = '';

      if (backdropInterval) clearInterval(backdropInterval);

      const backdropContainer = document.createElement('div');
      backdropContainer.className = 'backdrop-container';
      detailsContainer.appendChild(backdropContainer);

      const backdropA = document.createElement('div');
      backdropA.className = 'backdrop';
      const backdropB = document.createElement('div');
      backdropB.className = 'backdrop';
      backdropContainer.appendChild(backdropA);
      backdropContainer.appendChild(backdropB);

      let showingA = true;

      fetch(`https://api.themoviedb.org/3/${type}/${item.id}/images?api_key=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          const backdrops = (data.backdrops || []).map(b =>
            `https://image.tmdb.org/t/p/w780${b.file_path}`
          );
          if (backdrops.length) {
            let currentIndex = Math.floor(Math.random() * backdrops.length);

            backdropA.style.opacity = '0';
            backdropA.style.transition = 'opacity 1s ease-in-out';
            backdropA.style.backgroundImage = `url(${backdrops[currentIndex]})`;
            backdropA.offsetHeight;
            requestAnimationFrame(() => {
              backdropA.style.opacity = '1';
            });

            backdropInterval = setInterval(() => {
              let newIndex;
              do {
                newIndex = Math.floor(Math.random() * backdrops.length);
              } while (newIndex === currentIndex);
              currentIndex = newIndex;

              if (showingA) {
                backdropB.style.backgroundImage = `url(${backdrops[currentIndex]})`;
                backdropB.style.transition = 'opacity 1s ease-in-out';
                backdropB.style.opacity = '1';
                backdropA.style.opacity = '0';
              } else {
                backdropA.style.backgroundImage = `url(${backdrops[currentIndex]})`;
                backdropA.style.transition = 'opacity 1s ease-in-out';
                backdropA.style.opacity = '1';
                backdropB.style.opacity = '0';
              }
              showingA = !showingA;
            }, 5000);
          }
        });

      const detailsResponse = await fetch(`https://api.themoviedb.org/3/${type}/${item.id}?api_key=${apiKey}`);
      const details = await detailsResponse.json();

      // Fetch content rating
      let contentRating = 'N/A';
      if (type === 'movie') {
        const releaseData = await fetch(`https://api.themoviedb.org/3/movie/${item.id}/release_dates?api_key=${apiKey}`).then(r => r.json());
        const auRelease = releaseData.results.find(r => r.iso_3166_1 === 'AU');
        if (auRelease && auRelease.release_dates.length > 0) {
          contentRating = auRelease.release_dates[0].certification || 'N/A';
        }
      } else if (type === 'tv') {
        const ratingData = await fetch(`https://api.themoviedb.org/3/tv/${item.id}/content_ratings?api_key=${apiKey}`).then(r => r.json());
        const auRating = ratingData.results.find(r => r.iso_3166_1 === 'AU');
        contentRating = auRating ? auRating.rating : 'N/A';
      }

      // Fetch credits for director & cast
      const creditsData = await fetch(`https://api.themoviedb.org/3/${type}/${item.id}/credits?api_key=${apiKey}`).then(r => r.json());
      const director = type === 'movie'
        ? (creditsData.crew.find(c => c.job === 'Director')?.name || 'N/A')
        : (creditsData.crew.find(c => c.job === 'Executive Producer')?.name || 'N/A');
      const castList = creditsData.cast.slice(0, 5).map(c => c.name).join(', ') || 'N/A';

      const posterUrl = item.poster_path ? posterBaseUrl + item.poster_path : 'https://via.placeholder.com/185x278?text=No+Image';
      const title = item.title || item.name;
      const year = (item.release_date || item.first_air_date || 'N/A').substring(0, 4);
      const overview = item.overview || 'No overview available.';
      const tmdbUrl = `https://www.themoviedb.org/${type}/${item.id}`;

      const genres = details.genres?.map(g => g.name).join(', ') || 'N/A';
      let runtime = 'N/A';
      if (type === 'movie') {
        runtime = details.runtime ? details.runtime + ' min' : 'N/A';
      } else if (type === 'tv') {
        if (details.episode_run_time && details.episode_run_time.length > 0) {
          runtime = details.episode_run_time[0] + ' min';
        }
      }

      const rating = details.vote_average ? details.vote_average.toFixed(1) : 'N/A';

      const topRow = document.createElement('div');
      topRow.className = 'details-top-row';

      const posterArea = document.createElement('div');
      posterArea.className = 'details-poster-area';

      const posterImg = document.createElement('img');
      posterImg.src = posterUrl;
      posterImg.alt = title;

      const actionButtons = document.createElement('div');
      actionButtons.className = 'action-buttons';

      if (!currentListIds.has(item.id)) {
        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = 'Add to List';
        addBtn.dataset.id = item.id;
        addBtn.dataset.type = type;
        actionButtons.appendChild(addBtn);
      } else {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Delete from List';
        deleteBtn.dataset.id = item.id;
        deleteBtn.dataset.type = type;
        actionButtons.appendChild(deleteBtn);
      }

      const viewBtn = document.createElement('button');
      viewBtn.className = 'view-btn';
      viewBtn.textContent = 'View on TMDb';
      viewBtn.addEventListener('click', () => {
        window.open(tmdbUrl, '_blank');
      });
      actionButtons.appendChild(viewBtn);

      posterArea.appendChild(posterImg);
      posterArea.appendChild(actionButtons);

      const titleArea = document.createElement('div');
      titleArea.className = 'details-text-header';

      const titleH3 = document.createElement('h3');
      titleH3.textContent = `${title} (${year})`;

      // First row: content rating | genres | runtime
      const row1 = document.createElement('div');
      row1.style.fontSize = '14px';
      row1.textContent = `${contentRating} | ${genres} | ${runtime}`;

      // Second row: rating
      const row2 = document.createElement('div');
      row2.style.fontSize = '14px';
      row2.textContent = `Rating: ${rating}`;

      // Third row: director
      const row3 = document.createElement('div');
      row3.style.fontSize = '14px';
      row3.textContent = `Director: ${director}`;

      // Fourth row: cast
      const row4 = document.createElement('div');
      row4.style.fontSize = '14px';
      row4.textContent = `Cast: ${castList}`;

      titleArea.appendChild(titleH3);
      titleArea.appendChild(row1);
      titleArea.appendChild(row2);
      titleArea.appendChild(row3);
      titleArea.appendChild(row4);

      topRow.appendChild(posterArea);
      topRow.appendChild(titleArea);

      const overviewDiv = document.createElement('div');
      overviewDiv.className = 'details-overview';
      overviewDiv.textContent = overview;
detailsContainer.appendChild(topRow);
      detailsContainer.appendChild(overviewDiv);

      const addBtn = detailsContainer.querySelector('.add-btn');
      if (addBtn) {
        addBtn.addEventListener('click', (e) => {
          const mediaId = e.target.dataset.id;
          const mediaType = e.target.dataset.type;
          addItemToList(mediaId, mediaType);
        });
      }

      const deleteBtn = detailsContainer.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', (e) => {
          const mediaId = e.target.dataset.id;
          const mediaType = e.target.dataset.type;
          if (confirm('Are you sure you want to delete this item from the list?')) {
            deleteItemFromList(mediaId, mediaType);
          }
        });
      }
    }

    searchInput.addEventListener('input', async () => {
      const query = searchInput.value.trim();
      const type = searchType.value;
      if (query.length < 2) {
        autocompleteBox.innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${apiKey}&query=${encodeURIComponent(query)}`);
        const data = await response.json();

        autocompleteBox.innerHTML = '';

        if (data.results && data.results.length > 0) {
          data.results.slice(0, 10).forEach(item => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';

            const img = document.createElement('img');
            img.src = item.poster_path ? posterBaseUrl + item.poster_path : 'https://via.placeholder.com/50x75?text=No+Image';
            img.alt = item.title || item.name;

            const info = document.createElement('div');
            info.className = 'movie-info';

            const title = document.createElement('span');
            title.className = 'movie-title';
            title.textContent = item.title || item.name;

            const year = document.createElement('span');
            year.className = 'movie-year';
            year.textContent = (item.release_date || item.first_air_date || 'N/A').substring(0, 4);

            info.appendChild(title);
            info.appendChild(year);

            div.appendChild(img);
            div.appendChild(info);

            div.addEventListener('click', () => {
              displayDetails(item, type);
            });

            autocompleteBox.appendChild(div);
          });
        }
      } catch (error) {
        console.error('Search error:', error);
      }
    });

    document.addEventListener('click', (e) => {
      if (!document.getElementById('search-container').contains(e.target)) {
        autocompleteBox.innerHTML = '';
      }
    });

    searchType.addEventListener('change', () => {
      autocompleteBox.innerHTML = '';
      searchInput.value = '';
      detailsContainer.style.display = 'none';
      loadList();
    });

    function loadList() {
      const type = searchType.value;
      const listId = listIds[type];
      listHeading.textContent = type === 'movie' ? 'My Movie List' : 'My TV Show List';

      listContainer.innerHTML = 'Loading...';
      currentListIds.clear();

      fetch(`https://api.themoviedb.org/3/list/${listId}?api_key=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          listContainer.innerHTML = '';
          if (data.items?.length) {
            data.items.forEach(item => {
              currentListIds.add(item.id);

              const div = document.createElement('div');
              div.className = 'movie';
              div.dataset.id = item.id;
              div.dataset.type = type;

              const img = document.createElement('img');
              img.src = item.poster_path
                ? posterBaseUrl + item.poster_path
                : 'https://via.placeholder.com/120x180?text=No+Image';
              img.alt = item.title || item.name;

              const titleSpan = document.createElement('span');
              titleSpan.textContent = item.title || item.name;

              div.appendChild(img);
              div.appendChild(titleSpan);

              listContainer.appendChild(div);
            });
          } else {
            listContainer.innerHTML = '<p>No items in list.</p>';
          }
        })
        .catch(err => {
          listContainer.innerHTML = '<p>Failed to load list.</p>';
          console.error('Load list error:', err);
        });
    }

    loadList();

// Add this at the end of your script, after loadList() is defined and called

// Handle click on posters in the list to show details
listContainer.addEventListener('click', async (e) => {
  const movieDiv = e.target.closest('.movie');
  if (!movieDiv) return;

  const itemId = movieDiv.dataset.id;
  const itemType = movieDiv.dataset.type;

  try {
    const res = await fetch(`https://api.themoviedb.org/3/${itemType}/${itemId}?api_key=${apiKey}`);
    const itemData = await res.json();
    if (itemData) {
      displayDetails(itemData, itemType);
      window.scrollTo({ top: 0, behavior: 'smooth' }); // scroll to top
    }
  } catch (error) {
    console.error('Failed to fetch item details:', error);
  }
});

// Close details container when clicking outside it or clicking inside the search container
document.addEventListener('click', (e) => {
  if (
    detailsContainer.style.display === 'flex' && // details visible
    !detailsContainer.contains(e.target) &&      // clicked outside details container
    !e.target.closest('.movie') &&                // not clicking a poster
    ( !e.target.closest('#search-container') ||  // clicked outside search container
      e.target.closest('#search-container')      // or clicked inside search container to close
    )
  ) {
    detailsContainer.style.display = 'none';
  }
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
  </script>
</body>
</html>